<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FraudDesq â€“ Fidelity Bank</title>

<!-- MSAL (stable CDN) -->
<script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>

<style>
body{font-family:Arial, sans-serif;background:#0b1220;color:#fff;margin:0}
button{padding:12px 20px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;font-size:16px}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0b1220;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hidden{display:none}
.table{width:100%;border-collapse:collapse;margin-top:20px}
.table th,.table td{padding:10px;border-bottom:1px solid #1e293b}
.badge{background:#16a34a;padding:4px 10px;border-radius:6px}
</style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="overlay">
<h2>Connect Outlook Mailbox</h2>
<button id="loginBtn">Connect via Microsoft</button>
</div>

<!-- DASHBOARD -->
<div id="app" class="hidden">
<h2>Case Dashboard <span class="badge">Connected</span></h2>
<p id="mailbox"></p>

<table class="table">
<thead>
<tr>
<th>Case ID</th>
<th>Subject</th>
<th>Sender</th>
<th>Received</th>
</tr>
</thead>
<tbody id="cases"></tbody>
</table>
</div>

<script>

// ================= IMPORTANT CONFIG =================
// REPLACE THESE VALUES
const CLIENT_ID = "0d01af51-0a97-4f8a-886e-7b5f72bc5d76";
const TENANT_ID = "2a50328f-787b-4d68-b2e3-1c12440252ab";

// SHARED MAILBOX
const sharedMailbox = "ElectronicFraudTeam@fidelitybank.ng";


// ================= MSAL CONFIG =================
const msalConfig = {
    auth: {
        clientId: CLIENT_ID,
        authority: `https://login.microsoftonline.com/${TENANT_ID}`,
        redirectUri: window.location.origin
    },
    cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
    }
};

const loginRequest = {
    scopes: ["User.Read", "Mail.Read"]
};

const msalInstance = new msal.PublicClientApplication(msalConfig);


// ================= START APP =================
window.addEventListener("DOMContentLoaded", async () => {

    console.log("App loaded");

    // Attach login button
    const btn = document.getElementById("loginBtn");

    btn.addEventListener("click", () => {
        console.log("Login button clicked");
        msalInstance.loginRedirect(loginRequest);
    });

    // Handle redirect
    try {
        const response = await msalInstance.handleRedirectPromise();

        let account = null;

        if (response) {
            account = response.account;
            msalInstance.setActiveAccount(account);
        } else {
            account = msalInstance.getActiveAccount();
        }

        if (account) {
            console.log("User authenticated");
            showDashboard();
            await loadEmails();
        }

    } catch (err) {
        console.error("AUTH ERROR", err);
    }
});


// ================= UI =================
function showDashboard() {
    document.getElementById("overlay").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("mailbox").innerText = sharedMailbox;
}


// ================= TOKEN =================
async function getToken() {

    const request = {
        scopes: ["User.Read", "Mail.Read"],
        account: msalInstance.getActiveAccount()
    };

    const response = await msalInstance.acquireTokenSilent(request);

    console.log("Token acquired");

    return response.accessToken;
}


// ================= LOAD SHARED MAILBOX =================
async function loadEmails() {

    try {
        const token = await getToken();

        const endpoint = `https://graph.microsoft.com/v1.0/users/${sharedMailbox}/messages?$top=20&$orderby=receivedDateTime desc`;

        console.log("Calling Graph", endpoint);

        const res = await fetch(endpoint, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        if (!res.ok) {
            throw new Error("Graph failed " + res.status);
        }

        const data = await res.json();

        renderCases(data.value);

    } catch (err) {
        console.error("GRAPH ERROR", err);
        alert("Shared mailbox access failed. Ensure Full Access and admin consent.");
    }
}


// ================= RENDER =================
function renderCases(messages) {

    const table = document.getElementById("cases");
    table.innerHTML = "";

    if (!messages || messages.length === 0) {
        table.innerHTML = "<tr><td colspan='4'>No emails found</td></tr>";
        return;
    }

    messages.forEach((mail, i) => {

        const row = `
        <tr>
            <td>FRD-${new Date().getFullYear()}-${1000+i}</td>
            <td>${mail.subject || "No subject"}</td>
            <td>${mail.from?.emailAddress?.address || "Unknown"}</td>
            <td>${new Date(mail.receivedDateTime).toLocaleString()}</td>
        </tr>`;

        table.insertAdjacentHTML("beforeend", row);
    });
}

</script>

</body>
</html>
